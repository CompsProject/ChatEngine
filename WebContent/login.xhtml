<?xml version="1.0" encoding="UTF-8"?>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>Login Page</title>
     <link rel="stylesheet" type="text/css" href="login.css"/>
     
    <script src="utility.js" type="text/javascript"></script>
     <script type="application/javascript"><![CDATA[
        "use strict";

        
        var Chat = {};        
        var clientID = window.name;
        util_permIDCheck();        
        /*if (clientID == null){
          //debugging block
          alert('clientID is null');
          var xml = '<message type="requestID"></message>';
        }*/
        
        Chat.socket = null;
        
        var host = '';
        var adminGroupsCreated = null;
        var groupPrompt = false;
        //true - user has been prompted that groups exist/not exist - needs to be reminded
        //false group has not been prompted and assumes groups exist

        Chat.connect = (function(host) {
            if ('WebSocket' in window) {
                Chat.socket = new WebSocket(host);
                
            } else if ('MozWebSocket' in window) {
                Chat.socket = new MozWebSocket(host);                
            } else {
                Console.log('Error: WebSocket is not supported by this browser.');
                return;
            }

            Chat.socket.onopen = function () {
                
            };

            Chat.socket.onclose = function () {
                
            };
            
            // Chat.socket.onclose = util_close();

            Chat.socket.onmessage = function (message) {
                //message.data here will be in xml format               
                var xml = message.data;
                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(xml,"text/xml");
                var messageNode = xmlDoc.getElementsByTagName('message')[0];
                var messageType = messageNode.getAttribute('type');                
                
                if (messageType == 'displayChat'){
                	util_webRedirect('chat');
                  //window.location.href = 'http://'+window.location.host + '/Chat/chat.xhtml';
                  
                /*} else if (messageType == 'alert'){
                  //message to generate clientID
                  //this block is necessary if user logging in has not already been assigned id from server.                  
                  clientID = messageNode.getAttribute('senderID');
                  
                } else {
                  alert('invalid message received by login.xhtml');
                }*/
                
                } else if (messageType == 'redirect'){
                	util_redirect(messageNode);
                } else if (messageType == 'noPermID'){
                	util_noPermID();
                } else if (messageType == 'alert'){
                	var msgtext = messageNode.childNodes[0].nodeValue;
                	util_alert(msgtext);
                } else if (messageType == 'checkGroups'){
                	var checkGroups = messageNode.getAttribute('checkGroups');
                	if (checkGroups == 'Not Created') {
                		alert("There are no groups created currently.");
                		document.getElementById("joinBtn").disabled = true;
                		groupPrompt = true;
                	} else {
                		if(groupPrompt)
                			alert("Groups have been created/updated!");
                			
                		//generate number of groups to join, groupNum = checkGroups
                		var groupPicker = document.getElementById("groupSelection");
                		var groupNum = Number(checkGroups);
                		
                		//Remove extras (if groups < 4)
                		while (groupPicker.length > groupNum) {
                			groupPicker.remove(groupPicker.length-1);
                		}
                		//Add if less than
                		for (var i=groupPicker.length; i<groupNum; i++) {
                			var groupOpt = document.createElement('option');
                			groupOpt.text = "Group "+(i+1);
                			groupPicker.add(groupOpt);
                		}
                		document.getElementById("joinBtn").disabled = false;
                	}
                } else {
                	alert("Could not parse server message: \n"+
                		message.data);
                }
                           
                
                
            }
        });

        /* Chat.initialize = function() {
            if (window.location.protocol == 'http:') {
                Chat.connect('ws://' + window.location.host + '/Chat/login');
            } else {
                Chat.connect('wss://' + window.location.host + '/Chat/login');
            }
        }        
        
        Chat.initialize();     */
        
        Chat.initialize = util_webSocketConnect;
        Chat.initialize(); 
        window.onload = function () {
        	//alert('');
        	//Given up trying to make this work in Firefox
			setTimeout( "document.getElementById('emailAddress').focus();", 1);
        	};

        function joinGroup(){
          var groupNumber = document.getElementById('groupSelection').value;
          var username = document.getElementById('emailAddress').value;
          //store the username in persistent variable so chat page can access it.
          //window.name = window.name + "$" + username; dont change window.name
          var xml = '<message type="joinGroup" senderID="'+clientID+'" username="'+username+'"><text>'+groupNumber+'</text></message>';
          Chat.socket.send(xml);
        }       
                
    ]]>   
    
    
    </script>
  </head>

  <body>
    <h1>Join group to collaborate</h1>
    
    <label id='b'>
      Email Address:<br/>
      <input type='text' id='emailAddress'/>
      </label>
      <br/>
      Choose Group Number:<br/>
      <select id='groupSelection'>
      <!-- next phase of dev need to pull the number of groups from ChatAnnotation class -->
        <option value="1">Group 1</option>
        <option value="2">Group 2</option>
        <option value="3">Group 3</option>
        <option value="4">Group 4</option>
      </select>
      <button id="joinBtn" onclick='joinGroup()'>Join</button>
    
    
  
  </body>


</html>